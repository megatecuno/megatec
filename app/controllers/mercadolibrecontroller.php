<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'] ?? null;
        $refresh_token = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if (<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'administrador' && <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'] ?? null;
        $refresh_token = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if (<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'administrador' && <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'] = $access_token;
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if (<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'administrador' && <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'])) {
            <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'], <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'] ?? null;
        $refresh_token = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if (<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'administrador' && <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'] = $access_token;
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if (<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'administrador' && <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'])) {
            <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'], <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'] = $access_token;
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if (<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'administrador' && <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'])) {
            <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'], <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset(<?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'])) {
            $code = <?php
header('Content-Type: text/html; charset=utf-8');
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'config' . DIRECTORY_SEPARATOR . 'config.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'models' . DIRECTORY_SEPARATOR . 'mercadolibreapi.php';
require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'includes' . DIRECTORY_SEPARATOR . 'auth.php';

class mercadolibrecontroller {
    private $mlmodel;

    public function __construct() {
        session_start();
        $access_token = $_session['ml_access_token'] ?? null;
        $refresh_token = $_session['ml_refresh_token'] ?? null;
        $this->mlmodel = new mercadolibreapi($access_token, $refresh_token);
    }

    public function login() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        $auth_url = "https://auth.mercadolibre.com.ar/authorization?response_type=code&client_id=" . $this->mlmodel->app_id . "&redirect_uri=" . urlencode($this->mlmodel->redirect_uri);
        header("location: $auth_url");
        exit;
    }

    public function callback() {
        if (isset($_get['code'])) {
            $code = $_get['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

GET['code'];

            $token_url = "https://api.mercadolibre.com/oauth/token";
            $ch = curl_init();
            curl_setopt($ch, curlopt_url, $token_url);
            curl_setopt($ch, curlopt_post, true);
            curl_setopt($ch, curlopt_returntransfer, true);
            curl_setopt($ch, curlopt_postfields, http_build_query([
                'grant_type' => 'authorization_code',
                'client_id' => $this->mlmodel->app_id,
                'client_secret' => $this->mlmodel->client_secret,
                'code' => $code,
                'redirect_uri' => $this->mlmodel->redirect_uri
            ]));

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, curlinfo_http_code);
            curl_close($ch);

            if ($http_code === 200) {
                $data = json_decode($response, true);
                $access_token = $data['access_token'];
                $refresh_token = $data['refresh_token'] ?? null;

                session_start();
                $_session['ml_access_token'] = $access_token;
                $_session['ml_refresh_token'] = $refresh_token;

                header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
                exit;
            } else {
                die("? error al obtener token: " . $response);
            }
        } else {
            die("? error: no se recibió el código de autorización.");
        }
    }

    public function sincronizar() {
        requirelogin();
        if ($_session['user_rol'] !== 'administrador' && $_session['user_rol'] !== 'operario') {
            header("location: " . url_base);
            exit;
        }

        session_start();
        if (!isset($_session['ml_access_token'])) {
            $_session['error'] = "debes iniciar sesión con mercado libre primero.";
            header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
            return;
        }

        $seller_id = 'tu_id_de_vendedor'; // ¡reemplaza esto!

        try {
            $this->mlmodel->settokens($_session['ml_access_token'], $_session['ml_refresh_token']);
            if ($this->mlmodel->syncitemstodb($seller_id)) {
                $_session['mensaje'] = "? artículos de mercado libre sincronizados correctamente.";
            } else {
                $_session['error'] = "? error al sincronizar artículos.";
            }
        } catch (exception $e) {
            $_session['error'] = "? " . $e->getmessage();
        }

        header("location: " . url_base . "dashboard/administrador/ml_articulos.php");
        exit;
    }

    public function listar() {
        requirelogin();

        $this->mlmodel->query("select * from articulos where creador_id = 0 and estado = 'activo' order by fecha_creacion desc");
        $articulos_ml = $this->mlmodel->resultset();

        require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'header.php';
        ?>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2>?? artículos de mercado libre</h2>
            <div>
                <?php
header('Content-Type: text/html; charset=utf-8'); if (!isset($_session['ml_access_token'])): ?>
                    <a href="<?= url_base ?>login_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? iniciar sesión con mercado libre
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
                    <a href="<?= url_base ?>sincronizar_ml.php" class="btn" style="background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                        ?? sincronizar productos
                    </a>
                <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>
            </div>
        </div>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (isset($_session['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

SESSION['ml_access_token'])): ?>
            <div style="background:#4db6ac; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? conectado a mercado libre. última sincronización: <?= date('d/m/y h:i') ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="background:#ffb74d; color:white; padding:1rem; border-radius:4px; margin-bottom:2rem;">
                ? no estás conectado a mercado libre. haz clic en "iniciar sesión" para sincronizar tus productos.
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); if (empty($articulos_ml)): ?>
            <div style="background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center;">
                <p>no hay artículos de mercado libre sincronizados aún.</p>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); else: ?>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem;">
                <?php
header('Content-Type: text/html; charset=utf-8'); foreach ($articulos_ml as $articulo): ?>
                    <div style="background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1rem;">
                        <div style="background:#ffd700; padding:0.3rem 0.5rem; border-radius:4px; font-weight:bold; margin-bottom:0.5rem;">?? mercado libre</div>
                        <h3><?= htmlspecialchars($articulo['titulo']) ?></h3>
                        <p style="font-size:1.2rem; font-weight:bold; color:#4db6ac;">
                            $<?= number_format($articulo['precio'], 2, ',', '.') ?>
                        </p>
                        <p>stock: <?= $articulo['stock'] ?></p>
                        <a href="<?= url_base ?>articulo.php?id=<?= $articulo['id'] ?>" 
                           style="display:inline-block; background:#4db6ac; color:white; padding:0.5rem 1rem; text-decoration:none; border-radius:4px;">
                            ver en tienda
                        </a>
                    </div>
                <?php
header('Content-Type: text/html; charset=utf-8'); endforeach; ?>
            </div>
        <?php
header('Content-Type: text/html; charset=utf-8'); endif; ?>

        <?php
header('Content-Type: text/html; charset=utf-8'); require_once dirname(__dir__, 2) . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . 'templates' . DIRECTORY_SEPARATOR . 'footer.php'; ?>
        <?php
header('Content-Type: text/html; charset=utf-8');
    }
}
?>

